@using Onlyoffice.Api.Models

<FluentAutocomplete @ref="milestoneList"
        TOption="Milestone"
        Disabled="Disabled" AutoComplete="off"
        MaximumSelectedOptions="1" MaximumOptionsSearch="100"
        SelectedOptions="_selectedMilestone"
        SelectedOptionsChanged="OnSelectionChanged"
        OnOptionsSearch="OnSearch"
        Placeholder="Нет" >

    <SelectedOptionTemplate>
        <FluentBadge Appearance="Appearance.Accent">
            @context.Title
        </FluentBadge>
    </SelectedOptionTemplate>

    <MaximumSelectedOptionsMessage>
        Задача может принадлежать только одной вехе
    </MaximumSelectedOptionsMessage>

    <OptionTemplate>
        <FluentBadge Appearance="Appearance.Accent">
            @context.Title
        </FluentBadge>
    </OptionTemplate>

    <HeaderContent>
        <FluentLabel Color="Color.Accent"
            Style="padding: 8px; font-size: 11px; border-bottom: 1px solid var(--neutral-fill-stealth-hover);">
            Вехи проекта
        </FluentLabel>
    </HeaderContent>

    <FooterContent>
        @if (!context.Any())
        {
            <FluentLabel Style="font-size: 11px; text-align: center; width: 200px;">
                Нет результатов
            </FluentLabel>
        }
    </FooterContent>

</FluentAutocomplete>

@code {
    private bool _popoverOpen;
    private string _popoverGuid = Guid.NewGuid().ToString();
    FluentAutocomplete<Milestone> milestoneList = default!;
    IEnumerable<Milestone> _selectedMilestone = [];

    [CascadingParameter] TaskUpdateData Task { get; set; } = null!;
    [CascadingParameter] IProjectState State { get; set; } = null!;
    [Parameter] public bool Disabled { get; set; }

    protected override void OnInitialized()
    {
        var selected = State.Milestones.SingleOrDefault(x => x.Id == Task.MilestoneId);
        if (selected is not null)
        {
            _selectedMilestone = [selected];
        }
    }

    private void OpenPopover()
    {
        _popoverOpen = true;
    }

    void OnSelectionChanged(IEnumerable<Milestone> e)
    {
        var selectedMilestone = e.ToList();
        Task.MilestoneId = selectedMilestone.Any() ? selectedMilestone.Single().Id : null;
        this._selectedMilestone = selectedMilestone;
    }

    void OnSearch(OptionsSearchEventArgs<Milestone> e)
    {
        e.Items = State.Milestones
            .Where(x => x.Title.Contains(e.Text, StringComparison.OrdinalIgnoreCase))
            .OrderBy(m => m.Title);
    }
}
