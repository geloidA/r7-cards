@using Onlyoffice.Api.Models
@using Cardmngr.Application.Clients.Subtask
@using AutoMapper

@implements IDisposable

@inject IMapper Mapper
@inject IJSRuntime JSRuntime

<div class="d-flex align-items-center fs-6">
    <FluentIcon Value="@(new Icons.Regular.Size24.Check())"/>
    <span class="ms-1" style="color: var(--neutral-foreground-rest);">Подзадачи</span>
    <Tool Icon="@(new Icons.Regular.Size16.Add())" Class="ms-1" TooltipTitle="Добавить"
        Disabled="@(!Task.CanEdit || Task.IsClosed())" @onclick="ShowCreationModal" />
</div>
@if (Task.Subtasks.Count == 0)
{
    <span>Список пуст</span>
}

<div class="subtasks-list">
    @foreach (var subtask in Task.Subtasks.OrderBy(x => x.Status))
    {
        <SubtaskCard Subtask="subtask" />
    }
</div>

@code {
    [Inject] public ISubtaskClient SubtaskClient { get; set; } = null!;

    [CascadingParameter] OnlyofficeTask Task { get; set; } = null!;
    [CascadingParameter] IProjectState State { get; set; } = null!;
    [CascadingParameter(Name = "MiddleModal")] ModalOptions ModalOptions { get; set; } = null!;
    [CascadingParameter] IModalService Modal { get; set; } = default!;

    protected override void OnInitialized()
    {
        State.SubtasksChanged += StateHasChanged;
    }

    async Task ShowCreationModal()
    {
        var res = await Modal.Show<SubtaskCreationModal>("Добавление подзадачи", 
            new ModalParameters { { "Team", State.Team } }, ModalOptions).Result;

        if (res.Confirmed)
        {
            var data = (SubtaskUpdateData)res.Data!;
            var added = await SubtaskClient.CreateAsync(Task.Id, data);
            State.AddSubtask(Task.Id, added);
        }
    }

    public void Dispose()
    {
        State.SubtasksChanged -= StateHasChanged;
    }
}
