@using KolBlazor.Components.Timeline
@using Cardmngr.Models.EventArgs

@inject KolTimelineJsInterop TimelineInterop

@inherits KolComponentBase
@implements IAsyncDisposable

<div class="d-flex">
    <div @ref="element" style="max-width: 1700px;" class="overflow-scroll scrollbar-none" >
        <div @onwheel="ScaleTimeline" class="timeline-animation scrollbar-none" style=@($"width: {Width}px; min-width: 1700px; {@Style}") >
            <KolTimeline ShowTodayLine="true" Class="scrollbar-none py-0" >
                @if (Project.Milestones is { })
                {
                    foreach (var milestone in Project.Milestones)
                    {
                        <KolTimelineItem @key="milestone.Id" End="milestone.CheckDeadline()" Start="milestone.CheckStart()">
                            <TimelineMilestone Milestone="milestone" Project="Project" />
                        </KolTimelineItem>
                    }
                }
            </KolTimeline>
        </div>
    </div>
    <KolScaleSwitcher Class="ms-4" MinValue="MinScale" MaxValue="MaxScale" Step="Step" 
        @bind-CurrentValue="Width" />
</div>

@code {
    private int? lastProjectId;
    private ElementReference element;
    public const int MinScale = 1685;
    public const int MaxScale = 10000;
    public const int Step = 500;

    public int Width { get; set; }
    
    [Parameter] public ProjectModel Project { get; set; } = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await TimelineInterop.RegisterScrollHandler(element);
        }
    }

    protected override void OnParametersSet()
    {
        if (lastProjectId == null || Project.Id != lastProjectId)
        {
            InitializeEventHandlers(Project);
            lastProjectId = Project.Id;
        }
    }

    private void InitializeEventHandlers(ProjectModel project)
    {
        foreach (var task in project.Tasks())
            task.ModelChanged += Refresh;

        project.Milestones.CollectionChanged += _ => Refresh();

        foreach (var statusColumn in project.StatusBoard)
        {
            statusColumn.CollectionChanged += SubscribeRefreshHandler;
        }
    }

    private void ScaleTimeline(WheelEventArgs args)
    {
        if (Width >= MinScale && Width <= MaxScale)
            Width -= (int)(args.DeltaY * 1.5);
        else if (args.DeltaY > 0)
        {
            Width = Width >= MaxScale ? Width - Step : Width;
        }
        else
        {
            Width = Width <= MinScale ? Width + Step : Width;
        }
    }

    void Refresh() => StateHasChanged();

    private void SubscribeRefreshHandler(CollectionEventArgs<ITaskModel> args)
    {
        if (args.Item.Milestone != null) Refresh();

        if (args.Action == CollectionAction.Add)
        {
            args.Item.ModelChanged += Refresh;
        }
    }
    
    public ValueTask DisposeAsync()
    {
        return TimelineInterop.DisposeAsync();
    }
}