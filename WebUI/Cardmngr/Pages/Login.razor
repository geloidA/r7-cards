@page "/login"

@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage

<PageTitle>Вход</PageTitle>

@code {
    [CascadingParameter] Task<AuthenticationState>? AuthenticationState { get; set; }
    [CascadingParameter] IModalService Modal { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationState is { })
        {
            var state = await AuthenticationState;
            if (state.User.Identity!.IsAuthenticated)
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                var res = await ShowAuthentication();

                if (res.Confirmed)
                {
                    await LocalStorage.SetItemAsStringAsync("isauthenticated", "true");
                    NavigationManager.NavigateTo("/", true);
                }
            }
        }
    }

    async Task<ModalResult> ShowAuthentication()
    {
        var options = new ModalOptions
        {
            DisableBackgroundCancel = true,
            HideCloseButton = true,
            Position = ModalPosition.Middle
        };

        return await Modal.Show<Components.Modals.AuthModal>("Авторизация", options).Result;
    }
}
