@using Onlyoffice.Api.Models

@inject IProjectApi ProjectApi

@if (Responsibles is { })
{
    <Card>
        <CardBody style="max-height: 250px; overflow-y: scroll;">
            @foreach (var responsible in Responsibles)
            {
                <div @key="responsible" class="d-flex flex-row py-2 align-items-center">
                    <InputCheckbox @bind-Value="responsible.Checked" />
                    <div class="ms-1">
                        <UserAvatar User="responsible.Value"/>
                    </div>
                    <span class="ms-2">
                        @responsible.Value.DisplayName
                    </span>
                </div>
            }
        </CardBody>
    </Card>

    <div class="row mt-4">
        <div class="col d-flex justify-content-center">
            <Button Color="ButtonColor.Success" @onclick="Confirm" >ОК</Button>
        </div>
        <div class="col d-flex justify-content-center">
            <Button Color="ButtonColor.Secondary" @onclick="Cancel">Отмена</Button>
        </div>
    </div>
}
else
{
    <span>Загрузка</span>
}

@code {
    [CascadingParameter] BlazoredModalInstance Modal { get; set; } = default!;
    List<SelectionResponsible>? Responsibles;

    [Parameter] public List<string>? SelectedIds { get; set; }
    [Parameter] public int ProjectId { get; set; }

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        var team = await ProjectApi.GetProjectTeamAsync(ProjectId);
        Responsibles = team
            .Select(CreateSelectionResponsible)
            .ToList();
    }

    private SelectionResponsible CreateSelectionResponsible(UserProfile profile)
    {
        return new SelectionResponsible(SelectedIds?.Contains(profile.Id!) ?? false, new Responsible
        {
            Id = profile.Id,
            AvatarSmall = profile.AvatarSmall,
            DisplayName = profile.DisplayName,
            ProfileUrl = profile.ProfileUrl
        });
    }

    private async System.Threading.Tasks.Task Confirm()
    {
        var selected = Responsibles!
            .Where(x => x.Checked)
            .Select(x => x.Value)
            .ToList();
        
        await Modal.CloseAsync(ModalResult.Ok(selected));
    }

    private async System.Threading.Tasks.Task Cancel() => await Modal.CancelAsync();

    private class SelectionResponsible(bool isChecked, Responsible value)
    {
        public bool Checked { get; set; } = isChecked;
        public Responsible Value = value;
    }
}
