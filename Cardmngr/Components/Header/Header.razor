@inject IProjectApi ProjectApi
@inject AuthenticationStateProvider AuthenticationState

@using System.Text.Json

@implements IDisposable

<div class="bb-top-row px-4 d-flex" style="background-color: var(--main-col-bg);">
    <div class="col-md-1 d-flex justify-content-start">
        <Button class="py-0" Color="ButtonColor.Dark" Outline="true" @onclick="OpenSidebar" >
            <Icon Name="IconName.List" />
        </Button>
    </div>
    <div class="col-md-9">
        @HeaderTitle.Content
    </div>
    <div class="col-md-2 d-flex justify-content-end">
        <Toolbar />
        @if (currentUser is { })
        {
            <ProfileTool Class="ms-3" UserProfile="currentUser" />
        }
    </div>
</div>

@code {
    private List<Onlyoffice.Api.Models.Project> userProjects = null!;
    private Onlyoffice.Api.Models.UserProfile? currentUser;

    [CascadingParameter(Name = "DetailsModal")] ModalOptions Options { get; set; } = null!;
    [CascadingParameter] IModalService Modal { get; set; } = null!;
    [CascadingParameter] HeaderTitle HeaderTitle { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        HeaderTitle.ContentChanged += StateHasChanged;
        
        userProjects = await ProjectApi.GetUserProjectsAsync().ToListAsync();

        if (AuthenticationState is { })
        {
            var provider = AuthenticationState.ToCookieProvider();
            currentUser = JsonSerializer.Deserialize<Onlyoffice.Api.Models.UserProfile>(provider["Data"]);
        }
    }

    private async Task OpenSidebar()
    {
        await Modal.Show<HeaderMenuModal>("", new ModalParameters { { "UserProjects", userProjects } }, Options).Result;
    }

    public void Dispose()
    {
        HeaderTitle.ContentChanged -= StateHasChanged;
    }
}
