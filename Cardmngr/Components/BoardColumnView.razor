@using Modals
@using TypeStatus = Onlyoffice.Api.Models.TaskStatus

@inject IProjectApi ProjectApi

@implements IDisposable

<div class="@BoardColumn.CssName @CssDragOver @CssCollapsed" @ondrop="OnDrop"
    @ondragover:preventDefault @ondragenter:preventDefault @ondblclick="() => isCollapsed = !isCollapsed"
    @ondragover="@(() => { if (!highlighted) highlighted = true; })"
    @ondragleave="() => highlighted = false"
    style="user-select: none;">
    @if (isCollapsed)
    {
        <div class="d-flex flex-column mt-1">            
            <Badge class="align-self-center" Color="BadgeColor.Success">@BoardColumn.Count</Badge>
            <span class="mt-2 font-monospace text-vertical ">
                @BoardColumn.Title
            </span>
            <div class="mt-2 hidden align-self-center" >
                <Dropdown Size="Size.ExtraSmall" AutoClose="true" >
                    <DropdownToggleButton Color="ButtonColor.Light">
                        <Icon Name="IconName.ThreeDots" />
                    </DropdownToggleButton>
                    <DropdownMenu>
                        <DropdownItem @onclick="ShowCardModal"
                            >Добавить карточку</DropdownItem>
                    </DropdownMenu>
                </Dropdown>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-2 align-self-baseline">
            <div class="col-md-11 align-self-baseline" >
                <Badge Color="BadgeColor.Success">@BoardColumn.Count</Badge>
                <span class="ms-1 font-monospace" style="user-select: none;">
                    @BoardColumn.Title
                </span>
            </div>
            <div class="col-md-1 hidden d-flex flex-row justify-content-end">
                <Dropdown Size="Size.ExtraSmall" AutoClose="true" >
                    <DropdownToggleButton Color="ButtonColor.Light">
                        <Icon Name="IconName.ThreeDots" />
                    </DropdownToggleButton>
                    <DropdownMenu>
                        <DropdownItem @onclick="ShowCardModal"
                            >Добавить карточку</DropdownItem>
                    </DropdownMenu>
                </Dropdown>
            </div>
        </div>
        <ul class="card-container">
            @foreach (var card in BoardColumn)
            {
                <CardView Card="card" @key="card" />
            }
        </ul>
    }
</div>

@code {
    string CssDragOver => highlighted ? "dragover" : "";
    string CssCollapsed => isCollapsed ? "collapsed" : "";
    bool highlighted;
    bool isCollapsed;

    [CascadingParameter] public IModalService Modal { get; set; } = default!;
    [CascadingParameter] BlazorCards.Card? LastDraggedCard { get; set; }
    [Parameter] public BoardColumn BoardColumn { get; set; } = null!;
    [Parameter] public EventCallback<BlazorCards.Card> NewCardCreated { get; set; }

    private TypeStatus TypeStatus => BoardColumn.GetTaskStatus();

    protected override void OnInitialized()
    {
        BoardColumn.CssName = "board-column";
        BoardColumn.CollectionChanged += Refresh;
    }

    async Task OnDrop()
    {
        highlighted = false;
        if (LastDraggedCard is { })
        {
            if (TypeStatus.StatusType == (int)Status.Closed && !LastDraggedCard.CanMarkClosed())
            {
                var options = new ModalOptions { Position = ModalPosition.Middle, Size = Blazored.Modal.ModalSize.Automatic };
                var modal = Modal.Show<CloseCardConfirmModal>("Закрытие задачи", options);
                var res = await modal.Result;
                if (res.Cancelled)
                {
                    return;
                }
                LastDraggedCard.CloseSubtasks();
            }
            await UpdateCardStatus(LastDraggedCard);
            LastDraggedCard.Column!.Remove(LastDraggedCard);
            BoardColumn.Add(LastDraggedCard);
        }
    }

    private async Task UpdateCardStatus(BlazorCards.Card card)
    {
        var taskStatus = BoardColumn.GetTaskStatus();
        var task = card.GetTask();

        if (taskStatus.StatusType != task.Status || taskStatus.Id != task.CustomTaskStatus)
        {
            await ProjectApi.UpdateTaskStatusAsync(task.Id, (Status)taskStatus.StatusType, taskStatus.Id);
            task.Status = taskStatus.StatusType;
            task.CustomTaskStatus = taskStatus.IsDefault ? null : taskStatus.Id;
        }
    }
    
    private async Task ShowCardModal()
    {
        var options = new ModalOptions { Position = ModalPosition.Middle };
        var modal = Modal.Show<CardCreationModal>("Сформулируйте задачу 🤔💭", options);

        var res = await modal.Result;

        if (res.Confirmed)
        {
            var cardName = res.Data!.ToString()!;
            var card = new BlazorCards.Card(cardName);
            
            var task = await ProjectApi.CreateTaskAsync(BoardColumn.Board!.GetProject().Id, 
                cardName, 
                (Status)TypeStatus.StatusType, 
                TypeStatus.Id);

            card.Data = task;
            BoardColumn.Add(card);
            await NewCardCreated.InvokeAsync(card);
        }
    }

    private void Refresh() => StateHasChanged();
    private void Refresh(System.Collections.Specialized.NotifyCollectionChangedEventArgs e) => StateHasChanged();

    public void Dispose()
    {
        BoardColumn.CollectionChanged -= Refresh;
    }
}
